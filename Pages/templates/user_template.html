<!-- Filename: templates/user_template.html -->

<!DOCTYPE html>
<html>
<head>
    <title>AniList Stat Cards Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/user_styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}">
</head>
<body>
    <header>
        <a href="/">
            <img class="favicon" src="{{ url_for('static', filename='images/favicon.png') }}" alt="Site Icon" style="height: 64px; width: 64px;">
            <h1>ASCG - AniList Stat Cards Generator</h1>
        </a>
        <p>Version: v1.0</p>
    </header>
    <div class="center-container">
        <h1>{{ username }}</h1>

        <!-- SVG container -->
        <div class="svg-container">
            {% for key in keys %}
            <div class="svg-item">
                <div class="svg-wrapper">
                    <div class="svg-controls">
                        <div class="select-container">
                            <!-- Dropdown for SVG types -->
                            <select id="svg-type-{{ key }}" onchange="changeSvgType('{{ key }}')">
                                <option value="default" selected>Default</option>
                                {% for type in svg_types[key] %}
                                <option value="{{ type }}">{{ type }}</option>
                                {% endfor %}
                            </select>
                            <div class="arrow"></div>
                        </div>

                        <!-- Button to open color picker popup -->
                        <button id="color-button-{{ key }}" onclick="openColorPicker('{{ key }}')">Pick Colors</button>
                    </div>

                    <div id="{{ key }}">
                        Loading...
                    </div>

                    <script>
                    // When the page is loaded, fetch the SVGs for all keys
                    window.onload = function() {
                        {% for key in keys %}
                        fetchSvg('{{ key }}', '{{ username }}')();
                        {% endfor %}
                    };

                    function fetchSvg(key, username) {
                        return function() {
                            const url = `{{ url_for('get_svg', username='USERNAME', key='KEY') }}`.replace('KEY', key).replace('USERNAME', username);
                            fetch(url)
                                .then(response => {
                                    if (response.status === 404) {
                                        throw new Error('SVG not found');
                                    } else if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    return response.text();
                                })
                                .then(svg => {
                                    const container = document.getElementById(key);
                                    // If the SVG is not None, display the SVG
                                    container.innerHTML = `<img src="data:image/svg+xml;base64,${btoa(svg)}" />`;
                                })
                                .catch(error => {
                                    const container = document.getElementById(key);
                                    if (error.message === 'SVG not found') {
                                        // If the SVG is not found, display a button that can be clicked to fetch the SVG
                                        container.innerHTML = `<button class="svg-button" onclick="(fetchSvg('${key}', '${'username'}'))()">Retry creating SVG</button>`;
                                    } else {
                                        // Display an error message
                                        container.innerHTML = `Error: ${error.message}`;
                                    }
                                });
                        }
                    }
                    </script>

                    <!-- Color picker popup -->
                    <div id="color-picker-{{ key }}" style="display: none;">
                        <label for="color1-{{ key }}">Color 1:</label>
                        <input type="text" id="color1-{{ key }}" name="color1-{{ key }}" placeholder="#FFFFFF">
                        <label for="color2-{{ key }}">Color 2:</label>
                        <input type="text" id="color2-{{ key }}" name="color2-{{ key }}" placeholder="#FFFFFF">
                        <label for="color3-{{ key }}">Color 3:</label>
                        <input type="text" id="color3-{{ key }}" name="color3-{{ key }}" placeholder="#FFFFFF">
                        <label for="color4-{{ key }}">Color 4:</label>
                        <input type="text" id="color4-{{ key }}" name="color4-{{ key }}" placeholder="#FFFFFF">
                        <button onclick="applyColors('{{ key }}')">Apply colors</button>
                    </div>

                    <div class="button-wrapper">
                        <button class="link-button" onclick="showLink('{{ url_for('get_svg_from_db', username=username, key=key, _external=True) }}')">Show Link</button>
                        <button class="download-button" data-url="{{ url_for('get_svg_from_db', username=username, key=key, _external=True) }}" data-key="{{ key }}">Download PNG</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="{{ url_for('static', filename='scripts/fetch_data.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/download.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/show_link.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/arrows.js') }}"></script>
</body>
</html>